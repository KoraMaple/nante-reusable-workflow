name: "Reusable VM Destruction"

on:
  workflow_call:
    inputs:
      app_name:
        type: string
        description: 'Application Name (e.g. nexus, k3s, octopus)'
        required: true
      confirm_destroy:
        type: boolean
        description: 'Confirm destruction (set to true to actually destroy)'
        required: true
        default: false
      vlan_tag:
        type: string
        description: 'Network Zone'
        default: '20'
      cpu_cores:
        type: string
        description: 'CPU Cores'
        default: '2'
      ram_mb:
        type: string
        description: 'RAM in MB'
        default: '4096'
      disk_gb:
        type: string
        description: 'Disk Size (e.g. 20G)'
        default: '20G'
      vm_target_ip:
        type: string
        description: 'IP of the VM to destroy (must match VLAN subnet) - for single instance mode'
        required: false
        default: ''
      instances:
        type: string
        description: 'JSON map of instances for multi-instance deployments (e.g., {"node1":{"ip_address":"192.168.10.51"}}). Leave empty for single instance mode.'
        required: false
        default: ''
      environment:
        type: string
        description: 'Environment name (dev, staging, prod)'
        required: false
        default: 'dev'
      resource_type:
        type: string
        description: 'Resource type: vm or lxc'
        required: false
        default: 'vm'
      # Runner configuration
      runner_type:
        type: string
        description: 'Runner type: "github-hosted" (uses ubuntu-latest with Tailscale) or "self-hosted" (uses self-hosted runner with direct LAN access)'
        required: false
        default: 'self-hosted'
      tailscale_tags:
        type: string
        description: 'Tailscale ACL tags for GitHub-hosted runner (comma-separated, e.g., "tag:ci,tag:provision")'
        required: false
        default: 'tag:ci'
    secrets:
      DOPPLER_TOKEN:
        required: true
      DOPPLER_TARGET_PROJECT:
        required: true
      DOPPLER_TARGET_CONFIG:
        required: true
      GH_PAT:
        required: true
      # Optional: Required for GitHub-hosted runners
      TS_OAUTH_CLIENT_ID:
        required: false
      TS_OAUTH_CLIENT_SECRET:
        required: false

jobs:
  destroy:
    runs-on: ${{ inputs.runner_type == 'github-hosted' && 'ubuntu-latest' || 'self-hosted' }}
    
    steps:
      # Connect to Tailscale for GitHub-hosted runners
      - name: Connect to Tailscale
        if: inputs.runner_type == 'github-hosted'
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          tags: ${{ inputs.tailscale_tags }}

      - name: Checkout Reusable Workflow Repo
        uses: actions/checkout@v4
        with:
          repository: KoraMaple/nante-reusable-workflow
          ref: develop
          token: ${{ secrets.GH_PAT }}

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3
      
      - name: Configure Doppler
        run: |
          doppler setup --project "${{ secrets.DOPPLER_TARGET_PROJECT }}" --config "${{ secrets.DOPPLER_TARGET_CONFIG }}" --no-interactive
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}

      - name: Confirm Destruction
        run: |
          if [ "${{ inputs.confirm_destroy }}" != "true" ]; then
            echo "‚ùå Destruction aborted. Set 'confirm_destroy' to true to proceed."
            exit 1
          fi
          echo "‚úì Destruction confirmed for app: ${{ inputs.app_name }}"

      - name: Terraform Destroy with Doppler
        run: |
          doppler run -- bash <<'EOF'
          set -e
          
          # Mask sensitive values to prevent log exposure
          if [ -n "$MINIO_ROOT_PASSWORD" ]; then echo "::add-mask::$MINIO_ROOT_PASSWORD"; fi
          if [ -n "$PROXMOX_TOKEN_SECRET" ]; then echo "::add-mask::$PROXMOX_TOKEN_SECRET"; fi
          if [ -n "$TAILSCALE_OAUTH_CLIENT_SECRET" ]; then echo "::add-mask::$TAILSCALE_OAUTH_CLIENT_SECRET"; fi
          
          cd terraform/
          
          # Set AWS credentials for Terraform S3 backend
          export AWS_ACCESS_KEY_ID="$MINIO_ROOT_USER"
          export AWS_SECRET_ACCESS_KEY="$MINIO_ROOT_PASSWORD"
          
          # Set Proxmox credentials
          export TF_VAR_proxmox_api_url="$PROXMOX_API_URL"
          export TF_VAR_proxmox_api_token_id="$PROXMOX_TOKEN_ID"
          export TF_VAR_proxmox_api_token_secret="$PROXMOX_TOKEN_SECRET"
          export TF_VAR_ssh_public_key="$ANS_SSH_PUBLIC_KEY"
          
          # Set Tailscale credentials for Terraform provider
          export TAILSCALE_OAUTH_CLIENT_ID="$TAILSCALE_OAUTH_CLIENT_ID"
          export TAILSCALE_OAUTH_CLIENT_SECRET="$TAILSCALE_OAUTH_CLIENT_SECRET"
          export TAILSCALE_TAILNET="${TAILSCALE_TAILNET:--}"
          
          # Terraform Init
          terraform init \
            -backend-config="bucket=terraform-state" \
            -backend-config='endpoints={s3="http://192.168.20.10:9000"}' \
            -backend-config="access_key=$MINIO_ROOT_USER" \
            -backend-config="secret_key=$MINIO_ROOT_PASSWORD"
          
          # Select workspace
          terraform workspace select ${{ inputs.app_name }}
          
          # List available workspaces for debugging
          echo "Available workspaces:"
          terraform workspace list
          
          # Check if current workspace matches app_name
          CURRENT_WS=$(terraform workspace show)
          if [ "$CURRENT_WS" != "${{ inputs.app_name }}" ]; then
            echo "‚ùå Workspace '${{ inputs.app_name }}' does not exist."
            echo "   This means no infrastructure was provisioned with this app name."
            exit 1
          fi
          
          # Set Proxmox credentials
          export TF_VAR_proxmox_api_url="$PROXMOX_API_URL"
          export TF_VAR_proxmox_api_token_id="$PROXMOX_TOKEN_ID"
          echo "Destroying infrastructure for app: ${{ inputs.app_name }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "VLAN: ${{ inputs.vlan_tag }}"
          
          # Build destroy arguments based on deployment mode
          DESTROY_ARGS=(
            -auto-approve
            -var="app_name=${{ inputs.app_name }}"
            -var="environment=${{ inputs.environment }}"
            -var="vlan_tag=${{ inputs.vlan_tag }}"
            -var="vm_cpu_cores=${{ inputs.cpu_cores }}"
            -var="vm_ram_mb=${{ inputs.ram_mb }}"
            -var="vm_disk_gb=${{ inputs.disk_gb }}"
            -var="resource_type=${{ inputs.resource_type }}"
            -var="enable_tailscale_terraform=false"
          )
          
          # Add instances or vm_target_ip based on mode
          if [ -n "${{ inputs.instances }}" ]; then
            echo "Multi-instance mode"
            echo '${{ inputs.instances }}' > /tmp/instances.json
            DESTROY_ARGS+=(-var="instances=$(cat /tmp/instances.json)")
            echo "Instances to destroy:"
            cat /tmp/instances.json | jq -r 'to_entries[] | "  \(.key): \(.value.ip_address)"'
          else
            echo "Single-instance mode"
            echo "Target IP: ${{ inputs.vm_target_ip }}"
            DESTROY_ARGS+=(-var="vm_target_ip=${{ inputs.vm_target_ip }}")
          fi
          echo ""
          
          # Terraform Destroy
          terraform destroy "${DESTROY_ARGS[@]}"
          echo "‚úì Infrastructure destroyed successfully"
          if [ -n "${{ inputs.instances }}" ]; then
            echo "‚úì All instances removed from Proxmox"
          else
            echo "‚úì VM/LXC removed from Proxmox"
          fi
          echo "‚úì Tailscale devices cleaned up (if Terraform-managed)"
          echo "‚úì Terraform state cleaned up"
          
          # Note about manual cleanup
          echo ""
          echo "üìã Manual cleanup (if needed):"
          echo "  1. Remove Octopus Deploy targets manually if they were registered"
          echo "  2. Check Tailscale admin console for any orphaned devices"
          echo "  3. Verify Proxmox has no leftover resources"
          EOF
