name: "Reusable VM Destruction"

on:
  workflow_call:
    inputs:
      app_name:
        type: string
        description: 'Application Name (e.g. nexus, k3s, octopus)'
        required: true
      confirm_destroy:
        type: boolean
        description: 'Confirm destruction (set to true to actually destroy)'
        required: true
        default: false
      vlan_tag:
        type: string
        description: 'Network Zone'
        default: '20'
      cpu_cores:
        type: string
        description: 'CPU Cores'
        default: '2'
      ram_mb:
        type: string
        description: 'RAM in MB'
        default: '4096'
      disk_gb:
        type: string
        description: 'Disk Size (e.g. 20G)'
        default: '20G'
      vm_target_ip:
        type: string
        description: 'IP of the VM to destroy (must match VLAN subnet)'
        required: true
    secrets:
      DOPPLER_TOKEN:
        required: true
      GH_PAT:
        required: true

jobs:
  destroy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout Reusable Workflow Repo
        uses: actions/checkout@v4
        with:
          repository: KoraMaple/nante-reusable-workflow
          ref: develop
          token: ${{ secrets.GH_PAT }}

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3
        with:
          doppler_token: ${{ secrets.DOPPLER_TOKEN }}

      - name: Confirm Destruction
        run: |
          if [ "${{ inputs.confirm_destroy }}" != "true" ]; then
            echo "❌ Destruction aborted. Set 'confirm_destroy' to true to proceed."
            exit 1
          fi
          echo "✓ Destruction confirmed for app: ${{ inputs.app_name }}"

      - name: Terraform Init
        uses: ./.github/actions/terraform-init
        with:
          workspace: ${{ inputs.app_name }}
      
      - name: Verify Workspace Exists
        run: |
          cd terraform/
          # List available workspaces for debugging
          echo "Available workspaces:"
          terraform workspace list
          
          # Check if current workspace matches app_name
          CURRENT_WS=$(terraform workspace show)
          if [ "$CURRENT_WS" != "${{ inputs.app_name }}" ]; then
            echo "❌ Workspace '${{ inputs.app_name }}' does not exist."
            echo "   This means no infrastructure was provisioned with this app name."
            echo "   Available workspaces are listed above."
            exit 1
          fi

      - name: Terraform Destroy Plan
        env:
          TF_VAR_proxmox_api_url: ${{ env.PROXMOX_API_URL }}
          TF_VAR_proxmox_api_token_id: ${{ env.PROXMOX_TOKEN_ID }}
          TF_VAR_proxmox_api_token_secret: ${{ env.PROXMOX_TOKEN_SECRET }}
          TF_VAR_ssh_public_key: ${{ env.ANS_SSH_PUBLIC_KEY }}
        run: |
          cd terraform/
          # Show what will be destroyed
          terraform plan -destroy \
            -var="app_name=${{ inputs.app_name }}" \
            -var="vlan_tag=${{ inputs.vlan_tag }}" \
            -var="vm_target_ip=${{ inputs.vm_target_ip }}" \
            -var="vm_cpu_cores=${{ inputs.cpu_cores }}" \
            -var="vm_ram_mb=${{ inputs.ram_mb }}" \
            -var="vm_disk_gb=${{ inputs.disk_gb }}" \
            -out=destroy_plan

      - name: Terraform Destroy
        env:
          TF_VAR_proxmox_api_url: ${{ env.PROXMOX_API_URL }}
          TF_VAR_proxmox_api_token_id: ${{ env.PROXMOX_TOKEN_ID }}
          TF_VAR_proxmox_api_token_secret: ${{ env.PROXMOX_TOKEN_SECRET }}
          TF_VAR_ssh_public_key: ${{ env.ANS_SSH_PUBLIC_KEY }}
          AWS_ACCESS_KEY_ID: ${{ env.MINIO_ROOT_USER }}
          AWS_SECRET_ACCESS_KEY: ${{ env.MINIO_ROOT_PASSWORD }}
        run: |
          cd terraform/
          terraform apply destroy_plan
          
          echo "✓ VM '${{ inputs.app_name }}' has been destroyed."
