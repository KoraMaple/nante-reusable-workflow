name: "Reusable VM Destruction"

on:
  workflow_call:
    inputs:
      app_name:
        type: string
        description: 'Application Name (e.g. nexus, k3s, octopus)'
        required: true
      confirm_destroy:
        type: boolean
        description: 'Confirm destruction (set to true to actually destroy)'
        required: true
        default: false
      vlan_tag:
        type: string
        description: 'Network Zone'
        default: '20'
      cpu_cores:
        type: string
        description: 'CPU Cores'
        default: '2'
      ram_mb:
        type: string
        description: 'RAM in MB'
        default: '4096'
      disk_gb:
        type: string
        description: 'Disk Size (e.g. 20G)'
        default: '20G'
      vm_target_ip:
        type: string
        description: 'IP of the VM to destroy (must match VLAN subnet)'
        required: true
    secrets:
      DOPPLER_TOKEN:
        required: true
      DOPPLER_TARGET_PROJECT:
        required: true
      DOPPLER_TARGET_CONFIG:
        required: true
      GH_PAT:
        required: true

jobs:
  destroy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout Reusable Workflow Repo
        uses: actions/checkout@v4
        with:
          repository: KoraMaple/nante-reusable-workflow
          ref: develop
          token: ${{ secrets.GH_PAT }}

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Confirm Destruction
        run: |
          if [ "${{ inputs.confirm_destroy }}" != "true" ]; then
            echo "❌ Destruction aborted. Set 'confirm_destroy' to true to proceed."
            exit 1
          fi
          echo "✓ Destruction confirmed for app: ${{ inputs.app_name }}"

      - name: Terraform Destroy with Doppler
        run: |
          doppler run -- bash <<'EOF'
          set -e
          
          cd terraform/
          
          # Set AWS credentials for Terraform S3 backend
          export AWS_ACCESS_KEY_ID="$MINIO_ROOT_USER"
          export AWS_SECRET_ACCESS_KEY="$MINIO_ROOT_PASSWORD"
          
          # Terraform Init
          terraform init \
            -backend-config="bucket=terraform-state" \
            -backend-config='endpoints={s3="http://192.168.20.10:9000"}' \
            -backend-config="access_key=$MINIO_ROOT_USER" \
            -backend-config="secret_key=$MINIO_ROOT_PASSWORD"
          
          # Select workspace
          terraform workspace select ${{ inputs.app_name }}
          
          # List available workspaces for debugging
          echo "Available workspaces:"
          terraform workspace list
          
          # Check if current workspace matches app_name
          CURRENT_WS=$(terraform workspace show)
          if [ "$CURRENT_WS" != "${{ inputs.app_name }}" ]; then
            echo "❌ Workspace '${{ inputs.app_name }}' does not exist."
            echo "   This means no infrastructure was provisioned with this app name."
            exit 1
          fi
          
          # Set Proxmox credentials
          export TF_VAR_proxmox_api_url="$PROXMOX_API_URL"
          export TF_VAR_proxmox_api_token_id="$PROXMOX_TOKEN_ID"
          export TF_VAR_proxmox_api_token_secret="$PROXMOX_TOKEN_SECRET"
          export TF_VAR_ssh_public_key="$ANS_SSH_PUBLIC_KEY"
          
          # Terraform Destroy Plan
          terraform plan -destroy \
            -var="app_name=${{ inputs.app_name }}" \
            -var="vlan_tag=${{ inputs.vlan_tag }}" \
            -var="vm_target_ip=${{ inputs.vm_target_ip }}" \
            -var="vm_cpu_cores=${{ inputs.cpu_cores }}" \
            -var="vm_ram_mb=${{ inputs.ram_mb }}" \
            -var="vm_disk_gb=${{ inputs.disk_gb }}" \
            -out=destroy_plan
          
          # Terraform Destroy
          terraform apply destroy_plan
          
          echo "✓ VM '${{ inputs.app_name }}' has been destroyed."
          EOF
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
          DOPPLER_TARGET_PROJECT: "${{ secrets.DOPPLER_TARGET_PROJECT }}"
          DOPPLER_TARGET_CONFIG: "${{ secrets.DOPPLER_TARGET_CONFIG }}"
