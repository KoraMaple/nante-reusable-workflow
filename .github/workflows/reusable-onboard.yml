name: "Reusable Manual Onboarding"

on:
  workflow_call:
    inputs:
      target_ip:
        type: string
        description: 'Target IP Address'
        required: true
      ssh_user:
        type: string
        description: 'SSH User'
        required: true
        default: 'deploy'
      target_hostname:
        type: string
        description: 'Hostname to set'
        required: true
      app_role:
        type: string
        description: 'Application Role (e.g. nginx)'
        required: false
        default: ''
      # Octopus Deploy configuration
      octopus_environment:
        type: string
        description: 'Octopus Deploy environment (Development, Staging, Production)'
        required: false
        default: 'Development'
      octopus_roles:
        type: string
        description: 'Comma-separated Octopus roles (e.g., web-server,nginx)'
        required: false
        default: ''
      skip_octopus:
        type: boolean
        description: 'Skip Octopus Tentacle registration'
        required: false
        default: false
    secrets:
      DOPPLER_TOKEN:
        required: true
      DOPPLER_TARGET_PROJECT:
        required: true
      DOPPLER_TARGET_CONFIG:
        required: true
      GH_PAT:
        required: true

jobs:
  onboard:
    runs-on: self-hosted
    steps:
      - name: Checkout Reusable Workflow Repo
        uses: actions/checkout@v4
        with:
          repository: KoraMaple/nante-reusable-workflow
          ref: develop
          token: ${{ secrets.GH_PAT }}
          
      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3
      
      - name: Configure Doppler
        run: |
          doppler setup --project "${{ secrets.DOPPLER_TARGET_PROJECT }}" --config "${{ secrets.DOPPLER_TARGET_CONFIG }}" --no-interactive
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}

      - name: Run Ansible with Doppler
        run: |
          doppler run -- bash <<'EOF'
          set -e
          
          # Setup SSH agent with key from Doppler
          eval $(ssh-agent -s)
          echo "$SSH_PRIVATE_KEY" | ssh-add -
          
          cd ansible/
          
          # Install requirements
          ansible-galaxy install -r requirements.yml
          
          # Test connectivity
          echo "Testing Ansible connectivity to ${{ inputs.target_ip }}..."
          if ! ansible all -i "${{ inputs.target_ip }}," -m ping \
            --user "${{ inputs.ssh_user }}" \
            --ssh-common-args='-o StrictHostKeyChecking=no -o ConnectTimeout=10'; then
            echo "❌ ERROR: Ansible cannot connect to VM at ${{ inputs.target_ip }}"
            exit 1
          fi
          echo "✓ Ansible connectivity confirmed"
          
          # Run playbook
          ansible-playbook -i "${{ inputs.target_ip }}," site.yml \
            --user "${{ inputs.ssh_user }}" \
            --ssh-common-args='-o StrictHostKeyChecking=no' \
            --extra-vars "target_hostname=${{ inputs.target_hostname }}" \
            --extra-vars "app_role_name=${{ inputs.app_role }}"
          EOF

      - name: Register with Octopus Deploy
        if: ${{ inputs.skip_octopus != true }}
        run: |
          doppler run -- bash <<'EOF'
          set -e
          
          # Setup SSH agent
          eval $(ssh-agent -s)
          echo "$SSH_PRIVATE_KEY" | ssh-add -
          
          cd ansible/
          
          # Parse roles from comma-separated string
          ROLES_ARRAY=()
          if [ -n "${{ inputs.octopus_roles }}" ]; then
            IFS=',' read -ra ROLES_ARRAY <<< "${{ inputs.octopus_roles }}"
          fi
          
          # Build extra vars for Octopus
          OCTOPUS_VARS="octopus_environment=${{ inputs.octopus_environment }}"
          
          if [ ${#ROLES_ARRAY[@]} -gt 0 ]; then
            ROLES_JSON=$(printf '%s\n' "${ROLES_ARRAY[@]}" | jq -R . | jq -s .)
            OCTOPUS_VARS="$OCTOPUS_VARS target_roles=$ROLES_JSON"
          fi
          
          # Run octopus-tentacle role
          echo "Registering ${{ inputs.target_hostname }} with Octopus Deploy..."
          ansible-playbook -i "${{ inputs.target_ip }}," site.yml \
            --user "${{ inputs.ssh_user }}" \
            --ssh-common-args='-o StrictHostKeyChecking=no' \
            --extra-vars "target_hostname=${{ inputs.target_hostname }}" \
            --extra-vars "app_role_name=octopus-tentacle" \
            --extra-vars "$OCTOPUS_VARS"
          
          echo "✓ Successfully registered with Octopus Deploy"
          EOF