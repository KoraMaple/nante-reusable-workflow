# ⚠️ SECURITY NOTICE:
# This workflow defaults to GitHub-hosted runners for safety in public repositories.
# Only use runner_type: "self-hosted" in PRIVATE repositories with trusted contributors.
# Fork PRs will require manual approval before running infrastructure operations.

name: "Reusable Bootstrap Existing Infrastructure"

on:
  workflow_call:
    inputs:
      target_ip:
        type: string
        description: 'Target IP Address'
        required: true
      ssh_user:
        type: string
        description: 'Existing SSH User (root or admin with sudo)'
        required: true
        default: 'root'
      ssh_password_secret_name:
        type: string
        description: 'Name of the Doppler secret containing SSH password'
        required: true
        default: 'BOOTSTRAP_SSH_PASSWORD'
      # Runner configuration
      runner_type:
        type: string
        description: 'Runner type: "github-hosted" (uses ubuntu-latest with Tailscale) or "self-hosted" (uses self-hosted runner with direct LAN access). ⚠️ Use self-hosted ONLY in private repositories.'
        required: false
        default: 'github-hosted'
      tailscale_tags:
        type: string
        description: 'Tailscale ACL tags for GitHub-hosted runner (comma-separated, e.g., "tag:ci,tag:provision")'
        required: false
        default: 'tag:ci'
    secrets:
      DOPPLER_TOKEN:
        required: true
      DOPPLER_TARGET_PROJECT:
        required: true
      DOPPLER_TARGET_CONFIG:
        required: true
      GH_PAT:
        required: true
      # Optional: Required for GitHub-hosted runners
      TS_OAUTH_CLIENT_ID:
        required: false
      TS_OAUTH_CLIENT_SECRET:
        required: false

jobs:
  bootstrap:
    runs-on: ${{ inputs.runner_type == 'github-hosted' && 'ubuntu-latest' || 'self-hosted' }}
    # Prevent fork PRs from running infrastructure operations - maintainers must explicitly trigger
    if: |
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    steps:
      # Connect to Tailscale for GitHub-hosted runners
      - name: Connect to Tailscale
        if: inputs.runner_type == 'github-hosted'
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          tags: ${{ inputs.tailscale_tags }}

      - name: Checkout Reusable Workflow Repo
        uses: actions/checkout@v4
        with:
          repository: KoraMaple/nante-reusable-workflow
          ref: develop
          token: ${{ secrets.GH_PAT }}
          
      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3
      
      - name: Configure Doppler
        run: |
          doppler setup --project "${{ secrets.DOPPLER_TARGET_PROJECT }}" --config "${{ secrets.DOPPLER_TARGET_CONFIG }}" --no-interactive
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}

      - name: Check for sshpass
        run: |
          if ! command -v sshpass &> /dev/null; then
            echo "❌ ERROR: sshpass is not installed on this runner"
            echo ""
            echo "Please install sshpass on your self-hosted runner:"
            echo "  sudo apt-get update && sudo apt-get install -y sshpass"
            echo ""
            echo "Or configure passwordless sudo for the runner user:"
            echo "  echo '$(whoami) ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/github-runner"
            exit 1
          else
            echo "✓ sshpass is installed"
          fi

      - name: Bootstrap Deploy User
        run: |
          doppler run -- bash <<'EOF'
          set -e
          
          # Mask all sensitive values to prevent log exposure
          [ -n "$SSH_PRIVATE_KEY" ] && echo "::add-mask::$SSH_PRIVATE_KEY"
          [ -n "$ANS_SSH_PUBLIC_KEY" ] && echo "::add-mask::$ANS_SSH_PUBLIC_KEY"
          [ -n "$FREEIPA_ADMIN_PASSWORD" ] && echo "::add-mask::$FREEIPA_ADMIN_PASSWORD"
          [ -n "$OCTOPUS_API_KEY" ] && echo "::add-mask::$OCTOPUS_API_KEY"
          [ -n "$TS_AUTHKEY" ] && echo "::add-mask::$TS_AUTHKEY"
          [ -n "$TAILSCALE_AUTH_KEY" ] && echo "::add-mask::$TAILSCALE_AUTH_KEY"
          
          # Verify sshpass is available
          if ! command -v sshpass &> /dev/null; then
            echo "❌ ERROR: sshpass is not installed"
            exit 1
          fi
          
          cd ansible/
          
          # Install requirements
          ansible-galaxy install -r requirements.yml
          
          # Get password from Doppler - use indirect variable expansion
          SECRET_NAME="${{ inputs.ssh_password_secret_name }}"
          SSH_PASSWORD="${!SECRET_NAME}"
          
          # Mask the SSH password
          if [ -n "$SSH_PASSWORD" ]; then
            echo "::add-mask::$SSH_PASSWORD"
          fi
          
          if [ -z "$SSH_PASSWORD" ]; then
            echo "❌ ERROR: SSH password not found in Doppler secret: $SECRET_NAME"
            echo "Available environment variables (secrets filtered):"
            env | grep -v "PASSWORD\|SECRET\|TOKEN\|KEY\|PRIVATE" | sort
            exit 1
          fi
          
          echo "Bootstrapping deploy user on ${{ inputs.target_ip }}..."
          
          # Run bootstrap playbook with password authentication
          ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i "${{ inputs.target_ip }}," bootstrap.yml \
            --user "${{ inputs.ssh_user }}" \
            --extra-vars "ansible_ssh_pass=$SSH_PASSWORD" \
            --extra-vars "ansible_become_pass=$SSH_PASSWORD" \
            --connection=ssh
          
          echo "✓ Bootstrap complete! Deploy user created with SSH key access."
          echo "You can now use reusable-onboard workflow with this VM."
          EOF
