# ‚ö†Ô∏è SECURITY NOTICE:
# This workflow defaults to GitHub-hosted runners for safety in public repositories.
# Only use runner_type: "self-hosted" in PRIVATE repositories with trusted contributors.
# Jobs accessing internal services (Nexus, SonarQube) require Tailscale for GitHub-hosted runners.

name: "Reusable CI Build"

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      app_name:
        type: string
        description: 'Application name for artifact naming'
        required: true
      language:
        type: string
        description: 'Programming language (go, python, node, java)'
        required: true
      build_tool:
        type: string
        description: 'Build tool override (make, gradle, maven, npm, yarn, etc.)'
        required: false
        default: ''
      language_version:
        type: string
        description: 'Language version (e.g., "1.22" for Go, "3.11" for Python)'
        required: false
        default: ''
      working_directory:
        type: string
        description: 'Directory to run builds in'
        required: false
        default: '.'
      run_tests:
        type: boolean
        description: 'Whether to run tests'
        required: false
        default: true
      run_sonar_scan:
        type: boolean
        description: 'Whether to run SonarQube/SonarCloud scan'
        required: false
        default: true
      sonar_organization:
        type: string
        description: 'SonarCloud organization key (only for SonarCloud, leave empty for self-hosted SonarQube)'
        required: false
        default: ''
      artifact_type:
        type: string
        description: 'Type of artifact (binary, jar, docker, etc.)'
        required: false
        default: ''
      skip_nexus_upload:
        type: boolean
        description: 'Skip artifact upload to Nexus'
        required: false
        default: false
      runner_type:
        type: string
        description: 'Runner type: "github-hosted" (uses ubuntu-latest) or "self-hosted" (uses self-hosted runner). ‚ö†Ô∏è Use self-hosted ONLY in private repositories.'
        required: false
        default: 'github-hosted'
      use_tailscale:
        type: boolean
        description: 'Connect to Tailscale network (required for GitHub-hosted runners to access internal services)'
        required: false
        default: false
      tailscale_tags:
        type: string
        description: 'Tailscale ACL tags for the runner (comma-separated, e.g., "tag:ci,tag:build")'
        required: false
        default: 'tag:ci'
    secrets:
      DOPPLER_TOKEN:
        required: true
      DOPPLER_TARGET_PROJECT:
        required: true
      DOPPLER_TARGET_CONFIG:
        required: true

jobs:
  check-runner-access:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      runner: ${{ steps.select-runner.outputs.runner }}
    steps:
      - name: Select runner based on org membership
        id: select-runner
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const requestedRunner = '${{ inputs.runner_type }}';
            
            // Default to github-hosted
            let runner = 'ubuntu-latest';
            
            // SECURITY: Check the calling repository owner
            // For reusable workflows, context.payload.repository is the calling repo
            const callingRepo = context.payload.repository?.full_name || '';
            const callingOwner = callingRepo.split('/')[0];
            
            core.info(`Calling repository: ${callingRepo}`);
            core.info(`Calling owner: ${callingOwner}`);
            
            // Only allow KoraMaple org repositories to use self-hosted runners
            if (callingOwner !== 'KoraMaple') {
              core.warning('‚ö†Ô∏è External workflow call detected - forcing github-hosted runner for security');
              core.warning(`Called from: ${callingRepo}`);
              core.setOutput('runner', 'ubuntu-latest');
              return;
            }
            
            // Block fork PRs from self-hosted
            if (context.eventName === 'pull_request' || context.eventName === 'pull_request_target') {
              const prRepo = context.payload.pull_request?.head?.repo?.full_name;
              if (prRepo !== callingRepo) {
                core.warning('Fork PRs use GitHub-hosted runners only');
                core.setOutput('runner', 'ubuntu-latest');
                return;
              }
            }
            
            // If self-hosted requested, allow it for KoraMaple repos
            if (requestedRunner === 'self-hosted') {
              core.info(`‚úì ${callingRepo} is a KoraMaple repository - self-hosted allowed`);
              runner = 'self-hosted';
            }
            
            core.setOutput('runner', runner);

  fetch-secrets:
    needs: check-runner-access
    runs-on: ${{ needs.check-runner-access.outputs.runner }}
    timeout-minutes: 10
    outputs:
      NEXUS_URL: ${{ steps.get-secrets.outputs.NEXUS_URL }}
      NEXUS_USERNAME: ${{ steps.get-secrets.outputs.NEXUS_USERNAME }}
      NEXUS_PASSWORD: ${{ steps.get-secrets.outputs.NEXUS_PASSWORD }}
      SONAR_URL: ${{ steps.get-secrets.outputs.SONAR_URL }}
      SONAR_TOKEN: ${{ steps.get-secrets.outputs.SONAR_TOKEN }}
      TS_OAUTH_CLIENT_ID: ${{ steps.get-secrets.outputs.TS_OAUTH_CLIENT_ID }}
      TS_OAUTH_CLIENT_SECRET: ${{ steps.get-secrets.outputs.TS_OAUTH_CLIENT_SECRET }}
    steps:
      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3 # v3

      - name: Configure Doppler
        run: |
          doppler setup --project "$DOPPLER_TARGET_PROJECT" --config "$DOPPLER_TARGET_CONFIG" --no-interactive
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
          DOPPLER_TARGET_PROJECT: ${{ secrets.DOPPLER_TARGET_PROJECT }}
          DOPPLER_TARGET_CONFIG: ${{ secrets.DOPPLER_TARGET_CONFIG }}

      - name: Fetch secrets from Doppler
        id: get-secrets
        run: |
          doppler run -- bash <<'EOF'
          set -e
          
          # Mask sensitive values to prevent log exposure
          # Note: SONAR_TOKEN is NOT masked here so it can be passed via job outputs
          # It will be masked in the consuming jobs instead
          if [ -n "$NEXUS_PASSWORD" ]; then echo "::add-mask::$NEXUS_PASSWORD"; fi
          if [ -n "$TAILSCALE_OAUTH_CLIENT_ID" ]; then echo "::add-mask::$TAILSCALE_OAUTH_CLIENT_ID"; fi
          if [ -n "$TAILSCALE_OAUTH_CLIENT_SECRET" ]; then echo "::add-mask::$TAILSCALE_OAUTH_CLIENT_SECRET"; fi
          
          # Export secrets as outputs (passwords are masked above)
          echo "NEXUS_URL=${NEXUS_URL:-}" >> $GITHUB_OUTPUT
          echo "NEXUS_USERNAME=${NEXUS_USERNAME:-}" >> $GITHUB_OUTPUT
          echo "NEXUS_PASSWORD=${NEXUS_PASSWORD:-}" >> $GITHUB_OUTPUT
          echo "SONAR_URL=${SONAR_URL:-}" >> $GITHUB_OUTPUT
          echo "SONAR_TOKEN=${SONAR_TOKEN:-}" >> $GITHUB_OUTPUT
          echo "TS_OAUTH_CLIENT_ID=${TAILSCALE_OAUTH_CLIENT_ID:-}" >> $GITHUB_OUTPUT
          echo "TS_OAUTH_CLIENT_SECRET=${TAILSCALE_OAUTH_CLIENT_SECRET:-}" >> $GITHUB_OUTPUT
          
          # Log what was found (without values)
          [ -n "${NEXUS_URL:-}" ] && echo "‚úì NEXUS_URL found" || echo "‚ö†Ô∏è  NEXUS_URL not found"
          [ -n "${NEXUS_USERNAME:-}" ] && echo "‚úì NEXUS_USERNAME found" || echo "‚ö†Ô∏è  NEXUS_USERNAME not found"
          [ -n "${NEXUS_PASSWORD:-}" ] && echo "‚úì NEXUS_PASSWORD found" || echo "‚ö†Ô∏è  NEXUS_PASSWORD not found"
          [ -n "${SONAR_URL:-}" ] && echo "‚úì SONAR_URL found" || echo "‚ö†Ô∏è  SONAR_URL not found"
          [ -n "${SONAR_TOKEN:-}" ] && echo "‚úì SONAR_TOKEN found" || echo "‚ö†Ô∏è  SONAR_TOKEN not found"
          [ -n "${TAILSCALE_OAUTH_CLIENT_ID:-}" ] && echo "‚úì TAILSCALE_OAUTH_CLIENT_ID found" || echo "‚ö†Ô∏è  TAILSCALE_OAUTH_CLIENT_ID not found"
          [ -n "${TAILSCALE_OAUTH_CLIENT_SECRET:-}" ] && echo "‚úì TAILSCALE_OAUTH_CLIENT_SECRET found" || echo "‚ö†Ô∏è  TAILSCALE_OAUTH_CLIENT_SECRET not found"
          EOF
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}

  build:
    needs: [check-runner-access, fetch-secrets]
    runs-on: ${{ needs.check-runner-access.outputs.runner }}
    timeout-minutes: 30
    steps:
      - name: Connect to Tailscale
        if: inputs.use_tailscale == true && needs.check-runner-access.outputs.runner == 'ubuntu-latest'
        uses: tailscale/github-action@53acf823325fe9ca47f4cdaa951f90b4b0de5bb9 # v4
        with:
          oauth-client-id: ${{ needs.fetch-secrets.outputs.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ needs.fetch-secrets.outputs.TS_OAUTH_CLIENT_SECRET }}
          tags: ${{ inputs.tailscale_tags }}

      - name: Validate inputs
        run: |
          set -e
          
          # Validate app_name
          APP_NAME="${{ inputs.app_name }}"
          if [[ ! "$APP_NAME" =~ ^[a-zA-Z][a-zA-Z0-9_-]{0,62}$ ]]; then
            echo "::error::app_name must start with a letter and contain only alphanumeric characters, hyphens, or underscores"
            exit 1
          fi
          echo "‚úì app_name validated: $APP_NAME"
          
          # Validate language
          LANG="${{ inputs.language }}"
          if [[ ! "$LANG" =~ ^(go|python|node|java)$ ]]; then
            echo "::error::language must be one of: go, python, node, java"
            exit 1
          fi
          echo "‚úì language validated: $LANG"
          
          echo "‚úì All input validation passed"

      - name: Checkout caller repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # Go Setup
      - name: Setup Go
        if: inputs.language == 'go'
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version: ${{ inputs.language_version || '1.22' }}
          cache: true
          cache-dependency-path: ${{ inputs.working_directory }}/go.sum

      - name: Install Go dependencies
        if: inputs.language == 'go'
        working-directory: ${{ inputs.working_directory }}
        run: go mod download

      - name: Run Go tests
        if: inputs.language == 'go' && inputs.run_tests == true
        working-directory: ${{ inputs.working_directory }}
        run: go test -v -coverprofile=coverage.out ./...

      - name: Build Go
        if: inputs.language == 'go'
        working-directory: ${{ inputs.working_directory }}
        run: |
          BUILD_TOOL="${{ inputs.build_tool || 'make' }}"
          if [ "$BUILD_TOOL" == "make" ] && [ -f Makefile ]; then
            make build
          else
            # Default Go build - create bin directory and build
            mkdir -p bin
            go build -o bin/${{ inputs.app_name }} ./...
          fi

      # Python Setup
      - name: Setup Python
        if: inputs.language == 'python'
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: ${{ inputs.language_version || '3.11' }}
          cache: 'pip'
          cache-dependency-path: ${{ inputs.working_directory }}/requirements.txt

      - name: Install Python dependencies
        if: inputs.language == 'python'
        working-directory: ${{ inputs.working_directory }}
        run: |
          BUILD_TOOL="${{ inputs.build_tool || 'pip' }}"
          if [ "$BUILD_TOOL" == "poetry" ]; then
            pip install poetry
            poetry install
          elif [ "$BUILD_TOOL" == "pipenv" ]; then
            pip install pipenv
            pipenv install
          else
            # Default pip install
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            fi
          fi

      - name: Run Python tests
        if: inputs.language == 'python' && inputs.run_tests == true
        working-directory: ${{ inputs.working_directory }}
        run: |
          BUILD_TOOL="${{ inputs.build_tool || 'pip' }}"
          if [ "$BUILD_TOOL" == "poetry" ]; then
            poetry run pytest --cov --cov-report=xml
          elif [ "$BUILD_TOOL" == "pipenv" ]; then
            pipenv run pytest --cov --cov-report=xml
          else
            # Check if pytest is available, install if needed
            pip install pytest pytest-cov
            pytest --cov --cov-report=xml
          fi

      - name: Build Python
        if: inputs.language == 'python'
        working-directory: ${{ inputs.working_directory }}
        run: |
          BUILD_TOOL="${{ inputs.build_tool || 'pip' }}"
          if [ "$BUILD_TOOL" == "poetry" ]; then
            poetry build
          else
            # Create dist directory for wheel/sdist
            pip install build
            python -m build
          fi

      # Node Setup
      - name: Setup Node
        if: inputs.language == 'node'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ inputs.language_version || '20' }}
          cache: ${{ inputs.build_tool || 'npm' }}
          cache-dependency-path: ${{ inputs.working_directory }}/package-lock.json

      - name: Install Node dependencies
        if: inputs.language == 'node'
        working-directory: ${{ inputs.working_directory }}
        run: |
          BUILD_TOOL="${{ inputs.build_tool || 'npm' }}"
          if [ "$BUILD_TOOL" == "yarn" ]; then
            yarn install
          elif [ "$BUILD_TOOL" == "pnpm" ]; then
            npm install -g pnpm
            pnpm install
          else
            npm ci
          fi

      - name: Run Node tests
        if: inputs.language == 'node' && inputs.run_tests == true
        working-directory: ${{ inputs.working_directory }}
        run: |
          BUILD_TOOL="${{ inputs.build_tool || 'npm' }}"
          if [ "$BUILD_TOOL" == "yarn" ]; then
            yarn run test:cov
          elif [ "$BUILD_TOOL" == "pnpm" ]; then
            pnpm run test:cov
          else
            npm run test:cov
          fi

      - name: Upload coverage report (Node)
        if: inputs.language == 'node' && inputs.run_tests == true && inputs.run_sonar_scan == true
        uses: actions/upload-artifact@v4
        with:
          name: lcov-report
          path: ${{ inputs.working_directory }}/coverage/lcov.info
          retention-days: 1

      - name: Build Node
        if: inputs.language == 'node'
        working-directory: ${{ inputs.working_directory }}
        run: |
          BUILD_TOOL="${{ inputs.build_tool || 'npm' }}"
          if [ "$BUILD_TOOL" == "yarn" ]; then
            yarn build
          elif [ "$BUILD_TOOL" == "pnpm" ]; then
            pnpm build
          else
            npm run build
          fi

      # Java Setup
      - name: Setup Java
        if: inputs.language == 'java'
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: ${{ inputs.language_version || '17' }}
          distribution: 'temurin'
          cache: ${{ inputs.build_tool == 'gradle' && 'gradle' || 'maven' }}

      - name: Build and Test Java
        if: inputs.language == 'java'
        working-directory: ${{ inputs.working_directory }}
        run: |
          BUILD_TOOL="${{ inputs.build_tool || 'maven' }}"
          if [ "$BUILD_TOOL" == "gradle" ]; then
            if [ "${{ inputs.run_tests }}" == "true" ]; then
              ./gradlew build test
            else
              ./gradlew build -x test
            fi
          else
            # Maven
            if [ "${{ inputs.run_tests }}" == "true" ]; then
              mvn clean package
            else
              mvn clean package -DskipTests
            fi
          fi

      # Nexus Upload
      - name: Upload to Nexus
        if: inputs.skip_nexus_upload == false
        working-directory: ${{ inputs.working_directory }}
        env:
          NEXUS_URL: ${{ needs.fetch-secrets.outputs.NEXUS_URL }}
          NEXUS_USERNAME: ${{ needs.fetch-secrets.outputs.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ needs.fetch-secrets.outputs.NEXUS_PASSWORD }}
        run: |
          set -e
          
          # Check if Nexus credentials are available
          if [ -z "$NEXUS_URL" ] || [ -z "$NEXUS_USERNAME" ] || [ -z "$NEXUS_PASSWORD" ]; then
            echo "‚ö†Ô∏è  WARNING: Nexus credentials not found in Doppler"
            echo "Skipping artifact upload. To enable, add NEXUS_URL, NEXUS_USERNAME, and NEXUS_PASSWORD to Doppler."
            exit 0
          fi
          
          VERSION="${{ github.sha }}-${{ github.run_number }}"
          
          # Determine artifact path based on language
          case "${{ inputs.language }}" in
            go)
              ARTIFACT_PATH="bin/${{ inputs.app_name }}"
              ;;
            python)
              ARTIFACT_PATH="dist/"
              ;;
            node)
              ARTIFACT_PATH="dist/"
              ;;
            java)
              ARTIFACT_PATH="target/*.jar"
              ;;
            *)
              echo "‚ùå Unknown language: ${{ inputs.language }}"
              exit 1
              ;;
          esac
          
          echo "üì¶ Uploading artifacts to Nexus..."
          echo "Version: $VERSION"
          echo "Artifact path pattern: $ARTIFACT_PATH"
          
          # Upload to Nexus raw repository
          UPLOADED=0
          for file in $ARTIFACT_PATH; do
            if [ -f "$file" ]; then
              echo "Uploading: $file"
              curl -u ${NEXUS_USERNAME}:${NEXUS_PASSWORD} \
                --upload-file "$file" \
                "${NEXUS_URL}/repository/raw-hosted/${{ inputs.app_name }}/${VERSION}/$(basename $file)" \
                --fail-with-body
              echo "‚úì Uploaded $(basename $file)"
              UPLOADED=$((UPLOADED + 1))
            elif [ -d "$ARTIFACT_PATH" ]; then
              # If ARTIFACT_PATH is a directory, upload all files
              for subfile in "$ARTIFACT_PATH"/*; do
                if [ -f "$subfile" ]; then
                  echo "Uploading: $subfile"
                  curl -u ${NEXUS_USERNAME}:${NEXUS_PASSWORD} \
                    --upload-file "$subfile" \
                    "${NEXUS_URL}/repository/raw-hosted/${{ inputs.app_name }}/${VERSION}/$(basename $subfile)" \
                    --fail-with-body
                  echo "‚úì Uploaded $(basename $subfile)"
                  UPLOADED=$((UPLOADED + 1))
                fi
              done
              break
            fi
          done
          
          if [ $UPLOADED -eq 0 ]; then
            echo "‚ö†Ô∏è  WARNING: No artifacts found to upload"
            echo "Searched in: $ARTIFACT_PATH"
            exit 0
          fi
          
          echo "‚úì Successfully uploaded $UPLOADED artifact(s) to Nexus"

  sonar-scan:
    needs: [check-runner-access, fetch-secrets, build]
    runs-on: ${{ needs.check-runner-access.outputs.runner }}
    timeout-minutes: 20
    if: inputs.run_sonar_scan == true
    steps:
      - name: Connect to Tailscale
        if: inputs.use_tailscale == true && needs.check-runner-access.outputs.runner == 'ubuntu-latest'
        uses: tailscale/github-action@53acf823325fe9ca47f4cdaa951f90b4b0de5bb9 # v4
        with:
          oauth-client-id: ${{ needs.fetch-secrets.outputs.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ needs.fetch-secrets.outputs.TS_OAUTH_CLIENT_SECRET }}
          tags: ${{ inputs.tailscale_tags }}

      - name: Checkout caller repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0  # Full history for better SonarQube analysis

      # Setup language environment (needed for analysis)
      - name: Setup Go for analysis
        if: inputs.language == 'go'
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version: ${{ inputs.language_version || '1.22' }}
          cache: true
          cache-dependency-path: ${{ inputs.working_directory }}/go.sum

      - name: Setup Python for analysis
        if: inputs.language == 'python'
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: ${{ inputs.language_version || '3.11' }}

      - name: Download coverage report (Node)
        if: inputs.language == 'node'
        uses: actions/download-artifact@v4
        with:
          name: lcov-report
          path: ${{ inputs.working_directory }}/coverage

      - name: Setup Node for analysis
        if: inputs.language == 'node'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ inputs.language_version || '20' }}

      - name: Setup Java for analysis
        if: inputs.language == 'java'
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: ${{ inputs.language_version || '17' }}
          distribution: 'temurin'

      - name: Check SonarQube credentials
        id: check-sonar
        run: |
          if [ -z "${{ needs.fetch-secrets.outputs.SONAR_URL }}" ] || [ -z "${{ needs.fetch-secrets.outputs.SONAR_TOKEN }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  WARNING: SonarQube/SonarCloud credentials not found in Doppler"
            echo "Skipping code scan. To enable:"
            echo "  - Self-hosted SonarQube: Add SONAR_URL and SONAR_TOKEN to Doppler"
            echo "  - SonarCloud: Set SONAR_URL=https://sonarcloud.io and add SONAR_TOKEN to Doppler"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "‚úì SonarQube credentials found"
          fi

      - name: Create sonar-project.properties
        if: steps.check-sonar.outputs.skip == 'false'
        working-directory: ${{ inputs.working_directory }}
        run: |
          # Create sonar-project.properties if it doesn't exist
          if [ ! -f "sonar-project.properties" ]; then
            echo "Creating sonar-project.properties..."
            
            # Extract org and repo from GitHub context
            REPO_FULL_NAME="${{ github.repository }}"
            PROJECT_KEY="${REPO_FULL_NAME//\//_}"
            
            echo "Using project key: $PROJECT_KEY"
            
            cat > sonar-project.properties <<EOF
          sonar.projectKey=$PROJECT_KEY
          sonar.projectName=${{ inputs.app_name }}
          sonar.sources=.
          sonar.coverage.exclusions=**/*_test.go,**/test/**,**/tests/**,**/__tests__/**
          sonar.test.exclusions=**/*_test.go,**/test/**,**/tests/**,**/__tests__/**
          EOF
            
            # Add language-specific coverage paths
            case "${{ inputs.language }}" in
              go)
                if [ -f "coverage.out" ]; then
                  echo "sonar.go.coverage.reportPaths=coverage.out" >> sonar-project.properties
                fi
                ;;
              python)
                if [ -f "coverage.xml" ]; then
                  echo "sonar.python.coverage.reportPaths=coverage.xml" >> sonar-project.properties
                fi
                ;;
              java)
                if [ -d "target/site/jacoco" ]; then
                  echo "sonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml" >> sonar-project.properties
                fi
                ;;
            esac
            
            # Add SonarCloud organization if provided
            if [ -n "${{ inputs.sonar_organization }}" ]; then
              echo "sonar.organization=${{ inputs.sonar_organization }}" >> sonar-project.properties
              echo "‚úì Using SonarCloud organization: ${{ inputs.sonar_organization }}"
            fi
            
            echo "‚úì Generated sonar-project.properties"
          else
            echo "‚úì Using existing sonar-project.properties"
          fi

      - name: SonarQube/SonarCloud Scan
        if: steps.check-sonar.outputs.skip == 'false'
        uses: sonarsource/sonarqube-scan-action@v6
        with:
          projectBaseDir: ${{ inputs.working_directory }}
        env:
          SONAR_HOST_URL: ${{ needs.fetch-secrets.outputs.SONAR_URL }}
          SONAR_TOKEN: ${{ needs.fetch-secrets.outputs.SONAR_TOKEN }}

      - name: SonarQube Quality Gate
        if: steps.check-sonar.outputs.skip == 'false'
        working-directory: ${{ inputs.working_directory }}
        run: |
          # Read project key from sonar-project.properties
          if [ -f "sonar-project.properties" ]; then
            PROJECT_KEY=$(grep "^sonar.projectKey=" sonar-project.properties | cut -d'=' -f2)
          else
            # Fallback to generated key if properties file doesn't exist
            REPO_FULL_NAME="${{ github.repository }}"
            PROJECT_KEY="${REPO_FULL_NAME//\//_}"
          fi
          
          echo "‚úì SonarQube/SonarCloud scan completed"
          echo "üìä View results at: ${{ needs.fetch-secrets.outputs.SONAR_URL }}/dashboard?id=$PROJECT_KEY"
