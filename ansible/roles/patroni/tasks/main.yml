---
- name: Install prerequisites for PostgreSQL repository
  ansible.builtin.apt:
    name:
      - gnupg
      - curl
      - ca-certificates
    state: present
    update_cache: yes

- name: Add PostgreSQL APT repository key
  ansible.builtin.apt_key:
    url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
    state: present

- name: Add PostgreSQL APT repository
  ansible.builtin.apt_repository:
    repo: "deb http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main"
    state: present
    filename: pgdg

- name: Update apt cache after adding PostgreSQL repository
  ansible.builtin.apt:
    update_cache: yes

- name: Install PostgreSQL and dependencies
  ansible.builtin.apt:
    name:
      - postgresql-{{ postgresql_version }}
      - postgresql-server-dev-{{ postgresql_version }}
      - python3-pip
      - python3-psycopg2
      - python3-dev
      - gcc
      - libpq-dev
    state: present

- name: Stop and disable default PostgreSQL service
  ansible.builtin.systemd:
    name: postgresql
    state: stopped
    enabled: no

- name: Install Patroni and dependencies via pip
  ansible.builtin.pip:
    name:
      - patroni[etcd]
      - psycopg2-binary
    state: present
    executable: pip3
    extra_args: --break-system-packages

- name: Create Patroni configuration directory
  ansible.builtin.file:
    path: /etc/patroni
    state: directory
    owner: postgres
    group: postgres
    mode: '0755'

- name: Create Patroni data directory
  ansible.builtin.file:
    path: "{{ patroni_data_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0700'

- name: Create Patroni configuration
  ansible.builtin.template:
    src: patroni.yml.j2
    dest: /etc/patroni/patroni.yml
    owner: postgres
    group: postgres
    mode: '0600'
  notify: restart patroni

- name: Create Patroni systemd service
  ansible.builtin.template:
    src: patroni.service.j2
    dest: /etc/systemd/system/patroni.service
    mode: '0644'
  notify:
    - reload systemd
    - restart patroni

- name: Enable and start Patroni service
  ansible.builtin.systemd:
    name: patroni
    enabled: yes
    state: started
    daemon_reload: yes

- name: Wait for Patroni to be ready
  ansible.builtin.uri:
    url: "http://{{ ansible_default_ipv4.address }}:8008/health"
    status_code: 200
  register: result
  until: result.status == 200
  retries: 30
  delay: 10
