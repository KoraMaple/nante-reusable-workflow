---
- name: Validate Patroni backends configuration
  fail:
    msg: |
      patroni_backends variable is not defined or empty.
      You must pass Patroni backend server IPs when deploying HAProxy.
      
      Example:
        --extra-vars "patroni_backends=[{'name':'patroni-node1','ip':'192.168.20.61'},{'name':'patroni-node2','ip':'192.168.20.62'},{'name':'patroni-node3','ip':'192.168.20.63'}]"
  when: patroni_backends is not defined or patroni_backends | length == 0

- name: Parse patroni_backends if it's a JSON string
  set_fact:
    patroni_backends_parsed: "{{ patroni_backends if patroni_backends is not string else (patroni_backends | from_json) }}"

- name: Display Patroni backends configuration
  debug:
    msg: "Configuring HAProxy with {{ patroni_backends_parsed | length }} Patroni backend(s): {{ patroni_backends_parsed | map(attribute='ip') | list | join(', ') }}"

- name: Check if required ports are available
  ansible.builtin.wait_for:
    port: "{{ haproxy_port }}"
    state: stopped
    timeout: 1
  loop:
    - 5000
    - 5001
    - 7000
  loop_control:
    loop_var: haproxy_port
  register: port_check
  failed_when: false
  changed_when: false

- name: Display port availability
  debug:
    msg: "Port {{ port_result.haproxy_port }} is {{ 'available' if port_result.failed else 'in use' }}"
  loop: "{{ port_check.results }}"
  loop_control:
    loop_var: port_result
    label: "Port {{ port_result.haproxy_port }}"

- name: Install HAProxy
  ansible.builtin.apt:
    name: haproxy
    state: present
    update_cache: yes

- name: Create HAProxy configuration
  ansible.builtin.template:
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
    owner: root
    group: root
    mode: '0644'
    validate: haproxy -c -f %s
  notify: restart haproxy

- name: Enable and start HAProxy service
  ansible.builtin.systemd:
    name: haproxy
    enabled: yes
    state: started
  register: haproxy_start

- name: Check HAProxy service status
  ansible.builtin.systemd:
    name: haproxy
  register: haproxy_status

- name: Display HAProxy service status
  debug:
    msg:
      - "HAProxy service state: {{ haproxy_status.status.ActiveState }}"
      - "HAProxy service enabled: {{ haproxy_status.status.UnitFileState }}"

- name: Show HAProxy logs for debugging
  ansible.builtin.command: journalctl -u haproxy -n 50 --no-pager
  register: haproxy_logs_debug
  changed_when: false

- name: Display HAProxy logs
  debug:
    msg: "{{ haproxy_logs_debug.stdout_lines }}"

- name: Show HAProxy configuration
  ansible.builtin.command: cat /etc/haproxy/haproxy.cfg
  register: haproxy_config
  changed_when: false

- name: Display HAProxy configuration
  debug:
    msg: "{{ haproxy_config.stdout_lines }}"

- name: Verify HAProxy is listening on ports
  ansible.builtin.wait_for:
    port: "{{ verify_port }}"
    state: started
    timeout: 10
  loop:
    - 5000
    - 5001
    - 7000
  loop_control:
    loop_var: verify_port
  register: port_verify

- name: Show HAProxy logs if service failed
  ansible.builtin.command: journalctl -u haproxy -n 30 --no-pager
  register: haproxy_logs
  when: haproxy_status.status.ActiveState != 'active'
  changed_when: false

- name: Display HAProxy logs on failure
  debug:
    msg: "{{ haproxy_logs.stdout_lines }}"
  when: haproxy_status.status.ActiveState != 'active'

- name: Fail if HAProxy is not active
  fail:
    msg: "HAProxy failed to start. Check logs above for details."
  when: haproxy_status.status.ActiveState != 'active'

- name: Display HAProxy connection info
  debug:
    msg:
      - "==================================================================="
      - "HAProxy PostgreSQL Load Balancer Configured"
      - "==================================================================="
      - "Primary (read-write): {{ ansible_default_ipv4.address }}:5000"
      - "Replicas (read-only): {{ ansible_default_ipv4.address }}:5001"
      - "HAProxy Stats: http://{{ ansible_default_ipv4.address }}:7000/stats"
      - ""
      - "Connect to PostgreSQL:"
      - "  psql -h {{ ansible_default_ipv4.address }} -p 5000 -U postgres"
      - "==================================================================="
