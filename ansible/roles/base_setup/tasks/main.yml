---
- name: Set system hostname
  hostname:
    name: "{{ target_hostname }}"

- name: Update /etc/hosts with new hostname
  lineinfile:
    path: /etc/hosts
    regexp: '^127.0.1.1'
    line: "127.0.1.1 {{ target_hostname }}"

- name: Install essential packages
  apt:
    name:
      - curl
      - apt-transport-https
      - ca-certificates
      - gpg
      - unzip
      - rsyslog
    state: present
    update_cache: yes

- name: Check if running in a virtual machine
  shell: systemd-detect-virt
  register: virt_type
  changed_when: false
  failed_when: false

- name: Install QEMU Guest Agent (VMs only)
  apt:
    name: qemu-guest-agent
    state: present
  when: virt_type.stdout in ['kvm', 'qemu']

- name: Ensure QEMU Guest Agent is running (VMs only)
  service:
    name: qemu-guest-agent
    state: started
    enabled: yes
  when: virt_type.stdout in ['kvm', 'qemu']

- name: Check if Tailscale is already configured
  command: tailscale status --json
  register: tailscale_status
  failed_when: false
  changed_when: false

- name: Install and configure Tailscale (if not managed by Terraform)
  when: tailscale_status.rc != 0
  block:
    - name: Install Tailscale
      shell: "curl -fsSL https://tailscale.com/install.sh | sh"
      args:
        creates: /usr/bin/tailscale

    - name: Connect to Tailscale
      command: "tailscale up --authkey={{ ts_authkey }} --hostname={{ target_hostname }}"
      environment:
        TS_AUTHKEY: "{{ ts_authkey }}"
      register: tailscale_result
      changed_when: "'Success' in tailscale_result.stdout or tailscale_result.rc == 0"
      failed_when: false

- name: Verify Tailscale is connected
  when: tailscale_status.rc != 0
  block:
    - name: Wait for Tailscale to be online
      command: tailscale status --json
      register: tailscale_check
      until: tailscale_check.stdout | from_json | json_query('Self.Online') == true
      retries: 10
      delay: 3
      failed_when: false

- name: Display Tailscale status
  debug:
    msg: "Tailscale is {{ 'already configured' if tailscale_status.rc == 0 else 'newly configured' }}"

- name: Debug Observability Connection Vars
  debug:
    msg: "Connecting to Observability Stack at {{ oo_host }}"

- name: Fail if Observability Host is missing
  fail:
    msg: "OO_HOST is not defined. Cannot configure Grafana Alloy."
  when: oo_host is not defined or oo_host | length == 0

- name: Create alloy user with log permissions
  user:
    name: alloy
    system: yes
    groups: adm
    append: yes
    state: present

- name: Install and Configure Grafana Alloy with Debugging
  block:
    - name: Include Alloy Role
      ansible.builtin.include_role:
        name: grafana.grafana.alloy
  rescue:
    - name: Get Alloy Service Logs
      command: journalctl -u alloy -n 50 --no-pager
      register: alloy_logs
      ignore_errors: true

    - name: Print Alloy Logs
      debug:
        var: alloy_logs.stdout_lines

    - name: Fail execution
      fail:
        msg: "Alloy failed to start. See logs above for details."
  vars:
    alloy_config: |
      // 1. Collect System Metrics (node_exporter)
      prometheus.exporter.unix "default" {}

      // Add labels (hostname) to metrics
      discovery.relabel "system_metrics" {
        targets = prometheus.exporter.unix.default.targets
        rule {
          target_label = "instance"
          replacement  = "{{ target_hostname }}"
        }
        rule {
          target_label = "job"
          replacement  = "node_exporter"
        }
      }

      prometheus.scrape "metrics" {
        targets    = discovery.relabel.system_metrics.output
        forward_to = [prometheus.remote_write.grafana_stack.receiver]
      }

      prometheus.remote_write "grafana_stack" {
        endpoint {
          url = "http://{{ oo_host }}:9090/api/v1/write"
        }
      }

      // 2. Collect System Logs
      local.file_match "system_logs" {
        path_targets = [
          {
            __path__ = "/var/log/*.log",
            host     = "{{ target_hostname }}",
            job      = "system",
          },
          {
            __path__ = "/var/log/syslog",
            host     = "{{ target_hostname }}",
            job      = "system",
          },
        ]
      }

      loki.source.file "system_scrape" {
        targets    = local.file_match.system_logs.targets
        forward_to = [loki.write.grafana_stack.receiver]
      }

      loki.write "grafana_stack" {
        endpoint {
          url = "http://{{ oo_host }}:3100/loki/api/v1/push"
        }
      }