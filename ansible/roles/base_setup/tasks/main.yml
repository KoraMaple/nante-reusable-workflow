---
- name: Set system hostname
  hostname:
    name: "{{ target_hostname }}"

- name: Update /etc/hosts with new hostname
  lineinfile:
    path: /etc/hosts
    regexp: '^127.0.1.1'
    line: "127.0.1.1 {{ target_hostname }}"

- name: Install essential packages
  apt:
    name:
      - qemu-guest-agent
      - curl
      - apt-transport-https
      - ca-certificates
      - gpg
      - unzip
      - rsyslog
    state: present
    update_cache: yes

- name: Ensure QEMU Guest Agent is running
  service:
    name: qemu-guest-agent
    state: restarted
    enabled: yes

- name: Install Tailscale
  shell: "curl -fsSL https://tailscale.com/install.sh | sh"
  args:
    creates: /usr/bin/tailscale

- name: Connect to Tailscale
  command: "tailscale up --authkey={{ ts_authkey }} --hostname={{ target_hostname }}"
  environment:
    TS_AUTHKEY: "{{ ts_authkey }}"
  register: tailscale_result
  changed_when: "'Success' in tailscale_result.stdout"

- name: Debug OpenObserve Connection Vars
  debug:
    msg: "Connecting to OpenObserve at {{ oo_host }} with user {{ oo_user }}"

- name: Fail if OpenObserve Host is missing
  fail:
    msg: "OO_HOST is not defined. Cannot configure Grafana Alloy."
  when: oo_host is not defined or oo_host | length == 0

- name: Create alloy user with log permissions
  user:
    name: alloy
    system: yes
    groups: adm
    append: yes
    state: present

- name: Install and Configure Grafana Alloy with Debugging
  block:
    - name: Include Alloy Role
      ansible.builtin.include_role:
        name: grafana.grafana.alloy
  rescue:
    - name: Get Alloy Service Logs
      command: journalctl -u alloy -n 50 --no-pager
      register: alloy_logs
      ignore_errors: true

    - name: Print Alloy Logs
      debug:
        var: alloy_logs.stdout_lines

    - name: Fail execution
      fail:
        msg: "Alloy failed to start. See logs above for details."
  vars:
    alloy_config: |
      // 1. Collect System Metrics (node_exporter)
      prometheus.exporter.unix "default" {}

      // Add labels (hostname) to metrics
      discovery.relabel "system_metrics" {
        targets = prometheus.exporter.unix.default.targets
        rule {
          target_label = "instance"
          replacement  = "{{ target_hostname }}"
        }
        rule {
          target_label = "job"
          replacement  = "node_exporter"
        }
      }

      prometheus.scrape "metrics" {
        targets    = discovery.relabel.system_metrics.output
        forward_to = [prometheus.remote_write.openobserve.receiver]
      }

      // 1b. Collect Nginx Metrics (via local exporter sidecar)
      prometheus.scrape "nginx" {
        targets = [
          {
            __address__ = "127.0.0.1:9113",
            instance    = "{{ target_hostname }}",
            job         = "nginx_metrics",
          },
        ]
        forward_to = [prometheus.remote_write.openobserve.receiver]
      }

      prometheus.remote_write "openobserve" {
        endpoint {
          url = "http://{{ oo_host }}:5080/api/default/prometheus"
          basic_auth {
            username = {{ oo_user | to_json }}
            password = {{ oo_pass | to_json }}
          }
        }
      }

      // 2. Collect System Logs
      local.file_match "system_logs" {
        path_targets = [
          {
            __path__ = "/var/log/*.log",
            host     = "{{ target_hostname }}",
            job      = "system",
          },
          {
            __path__ = "/var/log/syslog",
            host     = "{{ target_hostname }}",
            job      = "system",
          },
        ]
      }

      loki.source.file "system_scrape" {
        targets    = local.file_match.system_logs.targets
        forward_to = [loki.write.openobserve.receiver]
      }

      // 3. Collect Nginx Logs
      local.file_match "nginx_logs" {
        path_targets = [
          {
            __path__ = "/var/log/nginx/*.log",
            host     = "{{ target_hostname }}",
            job      = "nginx",
          },
        ]
      }

      loki.source.file "nginx_scrape" {
        targets    = local.file_match.nginx_logs.targets
        forward_to = [loki.write.openobserve.receiver]
      }

      loki.write "openobserve" {
        endpoint {
          url = "http://{{ oo_host }}:5080/api/default/loki/api/v1/push"
          basic_auth {
            username = {{ oo_user | to_json }}
            password = {{ oo_pass | to_json }}
          }
        }
      }