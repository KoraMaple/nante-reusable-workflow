---
- name: "Global Infrastructure Configuration"
  hosts: all
  become: true
  vars:
    # We pull the authkey from the environment variable set in GitHub Action
    ts_authkey: "{{ lookup('env', 'TS_AUTHKEY') }}"
    oo_user: "{{ lookup('env', 'OO_USER') }}"
    oo_pass: "{{ lookup('env', 'OO_PASS') }}"
    # Sanitize OO_HOST to ensure it's just the IP/Hostname (strip http://, https://, and :port)
    oo_host: "{{ lookup('env', 'OO_HOST') | regex_replace('^https?://', '') | regex_replace(':[0-9]+$', '') }}"
    
    # Octopus Deploy configuration (from environment)
    octopus_server_url: "{{ lookup('env', 'OCTOPUS_SERVER_URL') }}"
    octopus_api_key: "{{ lookup('env', 'OCTOPUS_API_KEY') }}"
    octopus_space_id: "{{ lookup('env', 'OCTOPUS_SPACE_ID') | default('Spaces-1', true) }}"
    octopus_environment: "{{ lookup('env', 'OCTOPUS_ENVIRONMENT') | default('Development', true) }}"
    # octopus_roles can be passed as extra-vars from workflow (list format)
  
  roles:
    # Run base_setup only if no app_role_name, or if app_role is not mgmt-docker
    # (mgmt-docker handles its own complete Alloy config)
    - role: base_setup
      when: app_role_name is not defined or app_role_name == "" or app_role_name != "mgmt-docker"
    
    # This role only runs if you pass an app_role_name from GitHub
    - role: "{{ app_role_name }}"
      when: app_role_name is defined and app_role_name != ""