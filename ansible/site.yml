---
- name: "Global Infrastructure Configuration"
  hosts: all
  # become is controlled by workflow (--become flag)
  # VMs: become=true (deploy user needs sudo)
  # LXC: become=false (already running as root)
  vars:
    # We pull the authkey from the environment variable set in GitHub Action
    ts_authkey: "{{ lookup('env', 'TS_AUTHKEY') }}"
    oo_user: "{{ lookup('env', 'OO_USER') }}"
    oo_pass: "{{ lookup('env', 'OO_PASS') }}"
    # Sanitize OO_HOST to ensure it's just the IP/Hostname (strip http://, https://, and :port)
    oo_host: "{{ lookup('env', 'OO_HOST') | regex_replace('^https?://', '') | regex_replace(':[0-9]+$', '') }}"
    
    # Octopus Deploy configuration (from environment)
    octopus_server_url: "{{ lookup('env', 'OCTOPUS_SERVER_URL') }}"
    octopus_api_key: "{{ lookup('env', 'OCTOPUS_API_KEY') }}"
    octopus_space_id: "{{ lookup('env', 'OCTOPUS_SPACE_ID') | default('Spaces-1', true) }}"
    octopus_environment: "{{ lookup('env', 'OCTOPUS_ENVIRONMENT') | default('Development', true) }}"
    # octopus_roles can be passed as extra-vars from workflow (list format)
    # ansible_roles is a list of roles to apply (passed from workflow)
  
  tasks:
    # Run base_setup by default unless mgmt-docker is in the roles list
    # (mgmt-docker handles its own complete Alloy config and replaces base_setup)
    - name: Apply base_setup role
      include_role:
        name: base_setup
      when: ansible_roles is not defined or 'mgmt-docker' not in ansible_roles
    
    # Configure LDAP client on all VMs/CTs (except FreeIPA server itself)
    - name: Apply ldap-config role
      include_role:
        name: ldap-config
      when: 
        - ansible_roles is not defined or 'freeipa' not in ansible_roles
        - freeipa_admin_password is defined
    
    # Apply all roles from ansible_roles list
    - name: Apply custom roles
      include_role:
        name: "{{ item }}"
      loop: "{{ ansible_roles | default([]) }}"
      when: ansible_roles is defined and ansible_roles | length > 0